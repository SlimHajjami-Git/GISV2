<div class="reports-container">
  <div class="reports-header">
    <div class="header-left">
      <h1 class="page-title">
        <span class="title-icon">üìä</span>
        Rapports et Analyses
      </h1>
      <p class="page-subtitle">G√©n√©rez des rapports d√©taill√©s sur vos v√©hicules et activit√©s</p>
    </div>
  </div>

  <div class="reports-content">
    <div class="templates-section">
      <h2 class="section-title">Mod√®les de rapports disponibles</h2>

      @if (loading()) {
        <div class="loading-state">Chargement...</div>
      } @else {
        <div class="templates-grid">
          @for (template of templates(); track template.id) {
            <div class="template-card">
              <div class="template-icon">{{ getReportTypeIcon(template.type) }}</div>
              <div class="template-content">
                <h3 class="template-name">{{ template.name }}</h3>
                <p class="template-type">{{ getReportTypeLabel(template.type) }}</p>
                @if (template.is_default) {
                  <span class="template-badge">Par d√©faut</span>
                }
              </div>
              <button (click)="openGenerateModal(template)" class="btn-generate">
                G√©n√©rer
              </button>
            </div>
          }
        </div>
      }
    </div>

    <div class="generated-reports-section">
      <div class="section-header">
        <h2 class="section-title">Rapports g√©n√©r√©s</h2>
      </div>

      @if (reports().length === 0) {
        <div class="empty-state">
          <div class="empty-icon">üìÑ</div>
          <h3>Aucun rapport g√©n√©r√©</h3>
          <p>Commencez par g√©n√©rer votre premier rapport</p>
        </div>
      } @else {
        <div class="reports-list">
          @for (report of reports(); track report.id) {
            <div class="report-item">
              <div class="report-icon">{{ getReportTypeIcon(report.template?.type || 'custom') }}</div>
              <div class="report-info">
                <div class="report-name">{{ report.name }}</div>
                <div class="report-period">
                  Du {{ formatDate(report.period_start) }} au {{ formatDate(report.period_end) }}
                </div>
                <div class="report-meta">
                  Cr√©√© le {{ formatDateTime(report.created_at) }}
                </div>
              </div>
              <div class="report-status">
                <span class="badge" [class]="getStatusBadgeClass(report.status)">
                  {{ getStatusLabel(report.status) }}
                </span>
              </div>
              <div class="report-actions">
                @if (report.status === 'completed') {
                  <button (click)="viewReport(report)" class="btn-action" title="Voir">
                    üëÅÔ∏è
                  </button>
                  <button (click)="exportReport(report, 'pdf')" class="btn-action" title="Export PDF">
                    üìÑ
                  </button>
                  <button (click)="exportReport(report, 'excel')" class="btn-action" title="Export Excel">
                    üìä
                  </button>
                }
              </div>
            </div>
          }
        </div>
      }
    </div>
  </div>

  @if (showGenerateModal()) {
    <div class="modal-overlay" (click)="closeGenerateModal()">
      <div class="modal-content generate-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title">G√©n√©rer un rapport</h2>
          <button (click)="closeGenerateModal()" class="btn-close">√ó</button>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Type de rapport</label>
            <div class="report-type-display">
              <span class="type-icon">{{ getReportTypeIcon(selectedTemplate()!.type) }}</span>
              <span class="type-name">{{ selectedTemplate()!.name }}</span>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Nom du rapport *</label>
            <input
              type="text"
              [(ngModel)]="reportForm.name"
              class="form-input"
              placeholder="Ex: Rapport mensuel janvier 2024"
              required
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Date de d√©but *</label>
              <input
                type="date"
                [(ngModel)]="reportForm.period_start"
                class="form-input"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label">Date de fin *</label>
              <input
                type="date"
                [(ngModel)]="reportForm.period_end"
                class="form-input"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">V√©hicules (optionnel)</label>
            <select [(ngModel)]="reportForm.vehicle_ids" class="form-input" multiple>
              <option value="">Tous les v√©hicules</option>
              @for (vehicle of vehicles(); track vehicle.id) {
                <option [value]="vehicle.id">
                  {{ vehicle.brand }} {{ vehicle.model }} - {{ vehicle.registration_number }}
                </option>
              }
            </select>
            <p class="form-hint">Maintenez Ctrl (ou Cmd) pour s√©lectionner plusieurs v√©hicules</p>
          </div>
        </div>

        <div class="modal-footer">
          <button (click)="closeGenerateModal()" class="btn-secondary">Annuler</button>
          <button
            (click)="generateReport()"
            [disabled]="generating()"
            class="btn-primary">
            {{ generating() ? 'G√©n√©ration...' : 'G√©n√©rer le rapport' }}
          </button>
        </div>
      </div>
    </div>
  }

  @if (selectedReportData()) {
    <div class="modal-overlay" (click)="closeReportView()">
      <div class="modal-content report-view-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title">{{ selectedReportData()!.name }}</h2>
          <button (click)="closeReportView()" class="btn-close">√ó</button>
        </div>

        <div class="modal-body">
          <div class="report-view-header">
            <div class="report-view-info">
              <p><strong>P√©riode:</strong> Du {{ formatDate(selectedReportData()!.period_start) }}
                 au {{ formatDate(selectedReportData()!.period_end) }}</p>
              <p><strong>Type:</strong> {{ getReportTypeLabel(selectedReportData()!.template?.type || 'custom') }}</p>
              <p><strong>G√©n√©r√© le:</strong> {{ formatDateTime(selectedReportData()!.created_at) }}</p>
            </div>
          </div>

          <div class="report-view-content">
            <div class="info-message">
              <div class="info-icon">‚ÑπÔ∏è</div>
              <p>L'affichage d√©taill√© des donn√©es du rapport sera disponible prochainement. Pour l'instant, vous pouvez exporter le rapport au format PDF ou Excel.</p>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button (click)="exportReport(selectedReportData()!, 'pdf')" class="btn-secondary">
            üìÑ Exporter PDF
          </button>
          <button (click)="exportReport(selectedReportData()!, 'excel')" class="btn-primary">
            üìä Exporter Excel
          </button>
        </div>
      </div>
    </div>
  }
</div>
