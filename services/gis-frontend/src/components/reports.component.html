<app-layout>
  <div class="reports-page">
    <div class="reports-layout">
      <!-- SIDEBAR GAUCHE -->
      <aside class="reports-sidebar">
        <!-- Template Selector -->
        <div class="sidebar-row">
          <label class="field-label">Template</label>
          <select class="field-select" [(ngModel)]="selectedTemplateId" (change)="onTemplateChange()">
            <option value="">S√©lectionner...</option>
            @for (template of templates; track template.id) {
              <option [value]="template.id">{{ template.name }}</option>
            }
          </select>
        </div>

        <!-- Vehicle Selector (hidden for monthly reports) -->
        <div class="sidebar-row" *ngIf="selectedTemplate?.type !== 'monthly'">
          <label class="field-label">V√©hicule</label>
          <select class="field-select" [(ngModel)]="selectedVehicleId">
            <option value="">Tous les v√©hicules</option>
            @for (vehicle of vehicles; track vehicle.id) {
              <option [value]="vehicle.id">{{ vehicle.brand }} {{ vehicle.model }}</option>
            }
          </select>
        </div>

        <!-- Monthly Report Period Selector -->
        <div class="sidebar-row" *ngIf="selectedTemplate?.type === 'monthly'">
          <label class="field-label">P√©riode du rapport</label>
          <div class="monthly-period-row">
            <select class="field-select" [(ngModel)]="selectedMonthlyMonth" (change)="onMonthlyPeriodChange()">
              <option *ngFor="let m of monthlyMonths" [value]="m.value">{{ m.label }}</option>
            </select>
            <select class="field-select" [(ngModel)]="selectedMonthlyYear" (change)="onMonthlyPeriodChange()">
              <option *ngFor="let y of monthlyYears" [value]="y">{{ y }}</option>
            </select>
          </div>
        </div>

        <!-- Period Buttons (hidden for monthly reports) -->
        <div class="period-row" *ngIf="selectedTemplate?.type !== 'monthly'">
          <button *ngFor="let p of periods" 
            [class.active]="selectedPeriod === p.value"
            (click)="selectPeriod(p.value)">{{ p.label }}</button>
        </div>

        <!-- Interval (hidden for monthly reports) -->
        <div class="sidebar-row" *ngIf="selectedTemplate?.type !== 'monthly'">
          <label class="field-label">Intervalle</label>
          <div class="interval-row">
            <select class="field-select small" [(ngModel)]="intervalType">
              <option value="previous">Pr√©c√©dent</option>
              <option value="current">Actuel</option>
            </select>
            <input type="number" class="field-input small" [(ngModel)]="intervalValue" min="1" max="12">
            <select class="field-select small" [(ngModel)]="intervalUnit">
              <option value="days">jours</option>
              <option value="weeks">semaines</option>
              <option value="months">mois</option>
            </select>
          </div>
        </div>

        <!-- Including current (hidden for monthly reports) -->
        <div class="sidebar-row" *ngIf="selectedTemplate?.type !== 'monthly'">
          <label class="checkbox-row">
            <input type="checkbox" [(ngModel)]="includeCurrent">
            <span>Inclure p√©riode en cours</span>
          </label>
        </div>

        <!-- Action Buttons -->
        <div class="action-row">
          <button class="btn-clear" (click)="clearFilters()">Effacer</button>
          <button class="btn-execute" (click)="executeReport()" [disabled]="loading || !selectedTemplateId">
            @if (loading) {
              <span class="spinner"></span>
            }
            Ex√©cuter
          </button>
        </div>
        @if (!selectedTemplateId) {
          <div class="validation-hint">‚ö†Ô∏è S√©lectionnez un template</div>
        } @else if (!selectedVehicleId && selectedTemplate?.type === 'fuel') {
          <div class="validation-hint">‚ö†Ô∏è S√©lectionnez un v√©hicule</div>
        }

        <!-- Report Sections (Accordion) -->
        <div class="accordion-section">
          <div class="accordion-header" (click)="toggleSection('templates')">
            <span>Report templates</span>
            <svg [class.rotated]="expandedSections['templates']" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </div>
        </div>

        <div class="accordion-section">
          <div class="accordion-header" [class.active]="reportGenerated" (click)="toggleSection('result')">
            <span>Report result</span>
            <svg [class.rotated]="expandedSections['result']" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </div>
          @if (expandedSections['result'] && reportGenerated) {
            <div class="accordion-content">
              <div class="result-item" [class.active]="activeTab === 'statistics'" (click)="setActiveTab('statistics')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2"/>
                </svg>
                <span>Statistiques</span>
              </div>
              <div class="result-item" [class.active]="activeTab === 'table'" (click)="setActiveTab('table')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2"/>
                  <line x1="3" y1="9" x2="21" y2="9"/>
                  <line x1="9" y1="21" x2="9" y2="9"/>
                </svg>
                <span>{{ selectedTemplate?.name || 'Donn√©es' }}</span>
              </div>
              <div class="result-item" [class.active]="activeTab === 'chart'" (click)="setActiveTab('chart')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="20" x2="18" y2="10"/>
                  <line x1="12" y1="20" x2="12" y2="4"/>
                  <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                <span>Graphique</span>
              </div>
            </div>
          }
        </div>

        <!-- Chart Legend -->
        @if (reportGenerated && activeTab === 'chart') {
          <div class="chart-legend">
            <div class="legend-title">L√©gende</div>
            <label class="legend-item">
              <input type="checkbox" [(ngModel)]="chartLines.all" (change)="toggleAllLines()">
              <span class="legend-line" style="background: #64748b"></span>
              <span>Toutes les lignes</span>
            </label>
            <label class="legend-item">
              <input type="checkbox" [(ngModel)]="chartLines.speed">
              <span class="legend-line" style="background: #22c55e"></span>
              <span>Vitesse, km/h</span>
            </label>
            <label class="legend-item">
              <input type="checkbox" [(ngModel)]="chartLines.fuel">
              <span class="legend-line" style="background: #3b82f6"></span>
              <span>Niveau carburant, L</span>
            </label>
            <label class="legend-item">
              <input type="checkbox" [(ngModel)]="chartLines.consumption">
              <span class="legend-line" style="background: #f97316"></span>
              <span>Consommation, L/h</span>
            </label>
          </div>
        }
      </aside>

      <!-- WORKSPACE PRINCIPAL -->
      <main class="reports-workspace">
        @if (!reportGenerated) {
          <div class="empty-state">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
            </svg>
            <h3>G√©n√©rer un rapport</h3>
            <p>S√©lectionnez un template et un v√©hicule, puis cliquez sur Ex√©cuter</p>
          </div>
        } @else if (selectedTemplate?.type === 'monthly' && monthlyReport) {
          <!-- ========== MONTHLY REPORT DEDICATED SECTION ========== -->
          <div class="monthly-report-workspace">
            <!-- Charts Row 1: Trend -->
            <ui-card title="üìà Tendance distance et utilisation" [showHeader]="true">
              <div class="monthly-chart-container">
                <canvas #chartCanvas></canvas>
              </div>
            </ui-card>

            <!-- Charts Row 2: Bar + Pie side by side -->
            <div class="monthly-charts-row">
              <ui-card title="üìä Kilom√®tres par v√©hicule" [showHeader]="true">
                <div class="monthly-chart-container">
                  <canvas #kmBarChart></canvas>
                </div>
              </ui-card>
              
              <ui-card title="‚õΩ R√©partition carburant" [showHeader]="true">
                <div class="monthly-chart-container">
                  <canvas #fuelPieChart></canvas>
                </div>
              </ui-card>
            </div>

            <!-- Charts Row 3: Maintenance -->
            <ui-card title="üîß Co√ªts de maintenance par p√©riode" [showHeader]="true">
              <div class="monthly-chart-container">
                <canvas #maintenanceAreaChart></canvas>
              </div>
            </ui-card>

            <!-- Data Table -->
            <ui-card title="Rapport mensuel flotte" [showHeader]="true" [noPadding]="true">
              <div card-actions>
                <button class="export-btn-sm" (click)="exportReport('excel')">Export Excel</button>
              </div>
              <div class="monthly-table-wrapper">
                <table class="data-table monthly-table">
                  <thead>
                    <tr>
                      <th>V√©hicule</th>
                      <th>Plaque</th>
                      <th>Distance</th>
                      <th>Utilisation</th>
                      <th>Conso. moy.</th>
                      <th>Var. conso.</th>
                      <th>Co√ªt maint.</th>
                      <th>Var. co√ªt</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (row of tableData; track row.vehicleId) {
                      <tr>
                        <td class="vehicle-cell">
                          <span class="vehicle-color" [style.background-color]="chartColors[row.colorIndex % chartColors.length]"></span>
                          {{ row.vehicleName }}
                        </td>
                        <td class="plate-cell">{{ row.plate }}</td>
                        <td class="distance-cell">{{ row.totalDistanceFormatted }}</td>
                        <td class="utilization-cell">{{ row.utilizationRateFormatted }}</td>
                        <td class="consumption-cell">{{ row.fuelConsumptionFormatted }}</td>
                        <td class="variance-cell" [class.positive]="row.consumptionVariance < 0" [class.negative]="row.consumptionVariance > 0">
                          {{ row.consumptionVarianceFormatted }}
                        </td>
                        <td class="cost-cell">{{ row.maintenanceCostFormatted }}</td>
                        <td class="variance-cell" [class.positive]="row.costVariance < 0" [class.negative]="row.costVariance > 0">
                          {{ row.costVarianceFormatted }}
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </ui-card>
          </div>
        } @else {
          <!-- ========== OTHER REPORTS SECTION ========== -->
          <div class="workspace-content">
            <!-- Chart Section -->
            <div class="chart-section">
              <div class="section-toolbar">
                <div class="toolbar-left">
                  <button class="tool-btn" title="Zoom avant">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                      <line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/>
                    </svg>
                  </button>
                  <button class="tool-btn" title="Zoom arri√®re">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                      <line x1="8" y1="11" x2="14" y2="11"/>
                    </svg>
                  </button>
                  <button class="tool-btn" title="R√©initialiser">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                    </svg>
                  </button>
                </div>
                <div class="toolbar-center">
                  <span class="section-title">Graphique</span>
                </div>
                <div class="toolbar-right">
                  <button class="export-btn-sm" (click)="exportReport('png')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export
                  </button>
                </div>
              </div>
              <div class="chart-area">
                <canvas #chartCanvas></canvas>
              </div>
            </div>

            <!-- Table Section for non-monthly reports -->
            <div class="table-section">
              <div class="section-toolbar">
                <div class="toolbar-left">
                  <div class="pagination">
                    <button class="page-btn" [disabled]="currentPage === 1" (click)="goToPage(1)">¬´</button>
                    <button class="page-btn" [disabled]="currentPage === 1" (click)="goToPage(currentPage - 1)">‚Äπ</button>
                    <span class="page-info">{{ currentPage }} sur {{ totalPages }}</span>
                    <button class="page-btn" [disabled]="currentPage === totalPages" (click)="goToPage(currentPage + 1)">‚Ä∫</button>
                    <button class="page-btn" [disabled]="currentPage === totalPages" (click)="goToPage(totalPages)">¬ª</button>
                    <span class="items-info">√âl√©ments {{ startItem }} √† {{ endItem }} sur {{ tableData.length }}</span>
                    <select class="page-size-select" [(ngModel)]="pageSize" (change)="onPageSizeChange()">
                      <option [value]="10">10</option>
                      <option [value]="25">25</option>
                      <option [value]="50">50</option>
                    </select>
                  </div>
                </div>
                <div class="toolbar-center">
                  <span class="section-title">{{ selectedTemplate?.name || 'Donn√©es' }}</span>
                </div>
                <div class="toolbar-right">
                  <button class="export-btn-sm" (click)="exportReport('excel')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export
                  </button>
                </div>
              </div>
              <div class="table-wrapper">
                <table class="data-table">
                  <thead>
                    <tr>
                      @if (selectedTemplate?.type === 'fuel') {
                        <th>Date/Heure</th>
                        <th>Niveau</th>
                        <th>Variation</th>
                        <th>Type</th>
                        <th>Position</th>
                        <th>Vitesse</th>
                        <th>Odom√®tre</th>
                      } @else if (selectedTemplate?.type === 'daily') {
                        <th>Horaire</th>
                        <th>Type</th>
                        <th>Dur√©e</th>
                        <th>D√©tails</th>
                        <th>Lieu</th>
                      } @else if (selectedTemplate?.type === 'mileage') {
                        <th>Date</th>
                        <th>Distance</th>
                        <th>Trajets</th>
                        <th>Temps conduite</th>
                        <th>Vitesse moy.</th>
                        <th>Vitesse max</th>
                        <th>Odom√®tre</th>
                      } @else {
                        <th>Date/Heure</th>
                        <th>Valeur</th>
                        <th>D√©tails</th>
                        <th>Kilom√©trage</th>
                      }
                    </tr>
                  </thead>
                  <tbody>
                    @for (row of paginatedData; track $index) {
                      <tr [class.highlighted]="row.isAnomaly" [class.anomaly-row]="row.isAnomaly" [class.drive-row]="row.isDrive">
                        @if (selectedTemplate?.type === 'fuel') {
                          <td class="time-cell">{{ row.time }}</td>
                          <td class="value-cell">{{ row.fuelPercent }}</td>
                          <td class="change-cell" [class.positive]="row.fuelChange?.startsWith('+')" [class.negative]="row.fuelChange?.startsWith('-')">{{ row.fuelChange }}</td>
                          <td>{{ row.eventType }}</td>
                          <td class="location-cell">{{ row.location }}</td>
                          <td>{{ row.speed }}</td>
                          <td>{{ row.odometer }}</td>
                        } @else if (selectedTemplate?.type === 'daily') {
                          <td class="time-cell">{{ row.time }}</td>
                          <td class="type-cell">{{ row.type }}</td>
                          <td class="duration-cell">{{ row.duration }}</td>
                          <td class="details-cell">{{ row.details }}</td>
                          <td class="location-cell">{{ row.location }}</td>
                        } @else if (selectedTemplate?.type === 'mileage') {
                          <td class="date-cell">{{ row.date }}</td>
                          <td class="distance-cell" [class.high-mileage]="row.distanceValue > 100">{{ row.distance }}</td>
                          <td class="trips-cell">{{ row.tripCount }}</td>
                          <td class="duration-cell">{{ row.drivingTime }}</td>
                          <td class="speed-cell">{{ row.avgSpeed }}</td>
                          <td class="speed-cell">{{ row.maxSpeed }}</td>
                          <td class="odometer-cell">{{ row.odometer }}</td>
                        } @else {
                          <td class="time-cell">{{ row.time || row.date }}</td>
                          <td class="value-cell">{{ row.level || row.speed || row.distance }}</td>
                          <td>{{ row.consumption || row.limit || row.location || row.trips }}</td>
                          <td>{{ row.kilometrage || row.status || row.type || row.avgSpeed }}</td>
                        }
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        }
      </main>
    </div>
  </div>
</app-layout>
