<app-layout>
  <div class="reports-page">
    <div class="reports-layout">
      <!-- SIDEBAR GAUCHE -->
      <aside class="reports-sidebar">
        <!-- Template Selector -->
        <div class="sidebar-row">
          <label class="field-label">Template</label>
          <select class="field-select" [(ngModel)]="selectedTemplateId" (change)="onTemplateChange()">
            <option value="">Sélectionner...</option>
            @for (template of templates; track template.id) {
              <option [value]="template.id">{{ template.name }}</option>
            }
          </select>
        </div>

        <!-- Vehicle Selector -->
        <div class="sidebar-row">
          <label class="field-label">Véhicule</label>
          <select class="field-select" [(ngModel)]="selectedVehicleId">
            <option value="">Tous les véhicules</option>
            @for (vehicle of vehicles; track vehicle.id) {
              <option [value]="vehicle.id">{{ vehicle.brand }} {{ vehicle.model }}</option>
            }
          </select>
        </div>

        <!-- Period Buttons -->
        <div class="period-row">
          <button *ngFor="let p of periods" 
            [class.active]="selectedPeriod === p.value"
            (click)="selectPeriod(p.value)">{{ p.label }}</button>
        </div>

        <!-- Interval -->
        <div class="sidebar-row">
          <label class="field-label">Intervalle</label>
          <div class="interval-row">
            <select class="field-select small" [(ngModel)]="intervalType">
              <option value="previous">Précédent</option>
              <option value="current">Actuel</option>
            </select>
            <input type="number" class="field-input small" [(ngModel)]="intervalValue" min="1" max="12">
            <select class="field-select small" [(ngModel)]="intervalUnit">
              <option value="days">jours</option>
              <option value="weeks">semaines</option>
              <option value="months">mois</option>
            </select>
          </div>
        </div>

        <!-- Including current -->
        <div class="sidebar-row">
          <label class="checkbox-row">
            <input type="checkbox" [(ngModel)]="includeCurrent">
            <span>Inclure période en cours</span>
          </label>
        </div>

        <!-- Action Buttons -->
        <div class="action-row">
          <button class="btn-clear" (click)="clearFilters()">Effacer</button>
          <button class="btn-execute" (click)="executeReport()" [disabled]="loading">
            @if (loading) {
              <span class="spinner"></span>
            }
            Exécuter
          </button>
        </div>

        <!-- Report Sections (Accordion) -->
        <div class="accordion-section">
          <div class="accordion-header" (click)="toggleSection('templates')">
            <span>Report templates</span>
            <svg [class.rotated]="expandedSections['templates']" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </div>
        </div>

        <div class="accordion-section">
          <div class="accordion-header" [class.active]="reportGenerated" (click)="toggleSection('result')">
            <span>Report result</span>
            <svg [class.rotated]="expandedSections['result']" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </div>
          @if (expandedSections['result'] && reportGenerated) {
            <div class="accordion-content">
              <div class="result-item" [class.active]="activeTab === 'statistics'" (click)="setActiveTab('statistics')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2"/>
                </svg>
                <span>Statistiques</span>
              </div>
              <div class="result-item" [class.active]="activeTab === 'table'" (click)="setActiveTab('table')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2"/>
                  <line x1="3" y1="9" x2="21" y2="9"/>
                  <line x1="9" y1="21" x2="9" y2="9"/>
                </svg>
                <span>{{ selectedTemplate?.name || 'Données' }}</span>
              </div>
              <div class="result-item" [class.active]="activeTab === 'chart'" (click)="setActiveTab('chart')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="20" x2="18" y2="10"/>
                  <line x1="12" y1="20" x2="12" y2="4"/>
                  <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                <span>Graphique</span>
              </div>
            </div>
          }
        </div>

        <!-- Chart Legend -->
        @if (reportGenerated && activeTab === 'chart') {
          <div class="chart-legend">
            <div class="legend-title">Légende</div>
            <label class="legend-item">
              <input type="checkbox" [(ngModel)]="chartLines.all" (change)="toggleAllLines()">
              <span class="legend-line" style="background: #64748b"></span>
              <span>Toutes les lignes</span>
            </label>
            <label class="legend-item">
              <input type="checkbox" [(ngModel)]="chartLines.speed">
              <span class="legend-line" style="background: #22c55e"></span>
              <span>Vitesse, km/h</span>
            </label>
            <label class="legend-item">
              <input type="checkbox" [(ngModel)]="chartLines.fuel">
              <span class="legend-line" style="background: #3b82f6"></span>
              <span>Niveau carburant, L</span>
            </label>
            <label class="legend-item">
              <input type="checkbox" [(ngModel)]="chartLines.consumption">
              <span class="legend-line" style="background: #f97316"></span>
              <span>Consommation, L/h</span>
            </label>
          </div>
        }
      </aside>

      <!-- WORKSPACE PRINCIPAL -->
      <main class="reports-workspace">
        @if (!reportGenerated) {
          <div class="empty-state">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
            </svg>
            <h3>Générer un rapport</h3>
            <p>Sélectionnez un template et un véhicule, puis cliquez sur Exécuter</p>
          </div>
        } @else {
          <div class="workspace-content">
            <!-- Chart Section -->
            <div class="chart-section">
              <div class="section-toolbar">
                <div class="toolbar-left">
                  <button class="tool-btn" title="Zoom avant">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                      <line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/>
                    </svg>
                  </button>
                  <button class="tool-btn" title="Zoom arrière">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                      <line x1="8" y1="11" x2="14" y2="11"/>
                    </svg>
                  </button>
                  <button class="tool-btn" title="Réinitialiser">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                    </svg>
                  </button>
                </div>
                <div class="toolbar-center">
                  <span class="section-title">Graphique</span>
                </div>
                <div class="toolbar-right">
                  <button class="export-btn-sm" (click)="exportReport('png')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export
                  </button>
                </div>
              </div>
              <div class="chart-area">
                <canvas #chartCanvas></canvas>
              </div>
            </div>

            <!-- Table Section -->
            <div class="table-section">
              <div class="section-toolbar">
                <div class="toolbar-left">
                  <div class="pagination">
                    <button class="page-btn" [disabled]="currentPage === 1" (click)="goToPage(1)">«</button>
                    <button class="page-btn" [disabled]="currentPage === 1" (click)="goToPage(currentPage - 1)">‹</button>
                    <span class="page-info">{{ currentPage }} sur {{ totalPages }}</span>
                    <button class="page-btn" [disabled]="currentPage === totalPages" (click)="goToPage(currentPage + 1)">›</button>
                    <button class="page-btn" [disabled]="currentPage === totalPages" (click)="goToPage(totalPages)">»</button>
                    <span class="items-info">Éléments {{ startItem }} à {{ endItem }} sur {{ tableData.length }}</span>
                    <select class="page-size-select" [(ngModel)]="pageSize" (change)="onPageSizeChange()">
                      <option [value]="10">10</option>
                      <option [value]="25">25</option>
                      <option [value]="50">50</option>
                    </select>
                  </div>
                </div>
                <div class="toolbar-center">
                  <span class="section-title">{{ selectedTemplate?.name || 'Données' }}</span>
                </div>
                <div class="toolbar-right">
                  <button class="export-btn-sm" (click)="exportReport('excel')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export
                  </button>
                </div>
              </div>
              <div class="table-wrapper">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Emplacement</th>
                      <th>Quantité</th>
                      <th>Niveau initial</th>
                      <th>Niveau final</th>
                      <th>Capteur</th>
                      <th>Conducteur</th>
                      <th>Date/Heure</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (row of paginatedData; track $index) {
                      <tr [class.highlighted]="$index === 0">
                        <td class="location-cell">{{ row.location }}</td>
                        <td class="value-cell">{{ row.filled }}</td>
                        <td>{{ row.initialLevel }}</td>
                        <td>{{ row.finalLevel }}</td>
                        <td>{{ row.sensor }}</td>
                        <td>{{ row.driver }}</td>
                        <td class="time-cell">{{ row.time }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        }
      </main>
    </div>
  </div>
</app-layout>
