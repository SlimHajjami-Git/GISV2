<app-layout>
  <div class="monitoring-page">
    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat-item total">
        <div class="stat-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 17h-2v-6l2-5h9l4 5v6h-2"/>
            <circle cx="7" cy="17" r="2"/>
            <circle cx="17" cy="17" r="2"/>
          </svg>
        </div>
        <span class="stat-value">{{ stats.total }}</span>
        <span class="stat-label">Total</span>
      </div>
      <div class="stat-item online">
        <div class="stat-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
          </svg>
        </div>
        <span class="stat-value">{{ stats.online }}</span>
        <span class="stat-label">En ligne</span>
      </div>
      <div class="stat-item moving">
        <div class="stat-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 11 12 14 22 4"/>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
          </svg>
        </div>
        <span class="stat-value">{{ stats.moving }}</span>
        <span class="stat-label">En mouvement</span>
      </div>
      <div class="stat-item stopped">
        <div class="stat-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
        </div>
        <span class="stat-value">{{ stats.stopped }}</span>
        <span class="stat-label">Arrêtés</span>
      </div>
      <div class="stat-item offline">
        <div class="stat-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
          </svg>
        </div>
        <span class="stat-value">{{ stats.offline }}</span>
        <span class="stat-label">Hors ligne</span>
      </div>
    </div>

    <div class="monitoring-layout">
      <!-- Collapsible Left Panel -->
      <aside class="vehicles-panel" [class.collapsed]="isPanelCollapsed">
        <button class="panel-toggle" (click)="togglePanel()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline [attr.points]="isPanelCollapsed ? '9 18 15 12 9 6' : '15 18 9 12 15 6'"/>
          </svg>
        </button>

        <div class="panel-content" *ngIf="!isPanelCollapsed">
          <div class="panel-header">
            <input
              type="text"
              class="search-input"
              placeholder="Rechercher..."
              [value]="searchQuery"
              (input)="onSearchChange($any($event.target).value)"
            />
            <select
              class="filter-select"
              [value]="filterStatus"
              (change)="onFilterStatusChange($any($event.target).value)"
            >
              <option value="all">Tous</option>
              <option value="online">En ligne</option>
              <option value="moving">En mouvement</option>
              <option value="stopped">Arrêtés</option>
              <option value="offline">Hors ligne</option>
            </select>
          </div>

          <div class="vehicles-list">
            <div
              class="vehicle-item"
              *ngFor="let vehicle of filteredVehicles; trackBy: trackByVehicleId"
              [class.selected]="selectedVehicle?.id === vehicle.id"
              (click)="selectVehicle(vehicle)"
            >
              <div class="vehicle-status" [class]="getVehicleStatusClass(vehicle)"></div>
              <div class="vehicle-details">
                <span class="vehicle-name">{{ vehicle.brand }} {{ vehicle.model }}</span>
                <span class="vehicle-plate">{{ vehicle.plate }}</span>
              </div>
              <span class="vehicle-speed" *ngIf="vehicle.isOnline">
                {{ vehicle.currentSpeed || 0 }} km/h
              </span>
            </div>

            <div class="empty-state" *ngIf="filteredVehicles.length === 0">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
              </svg>
              <p>Aucun véhicule</p>
            </div>
          </div>
        </div>
      </aside>

      <!-- Map Container -->
      <div class="map-container">
        <div class="map-toolbar">
          <div class="toolbar-left">
            <button class="toolbar-btn" [class.active]="mapStyle === 'streets'" (click)="changeMapStyle('streets')">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 6v16l7-4 8 4 7-4V2l-7 4-8-4-7 4z"/><path d="M8 2v16M16 6v16"/>
              </svg>
              Plan
            </button>
            <button class="toolbar-btn" [class.active]="mapStyle === 'satellite'" (click)="changeMapStyle('satellite')">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M12 2a7 7 0 1 0 10 10"/>
              </svg>
              Satellite
            </button>
            <button class="toolbar-btn" [class.active]="mapStyle === 'terrain'" (click)="changeMapStyle('terrain')">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m3 8 4-4 4 4 4-4 4 4v13H3V8z"/>
              </svg>
              Terrain
            </button>
          </div>
          <div class="toolbar-right">
            <button class="toolbar-btn icon-only" (click)="refresh()" title="Actualiser">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
                <path d="M21 3v5h-5"/>
              </svg>
            </button>
          </div>
        </div>

        <div id="tracking-map" class="map"></div>

        <!-- Vehicle Popup on Map -->
        <div 
          class="vehicle-popup-panel" 
          *ngIf="selectedVehicle"
          [class.dragging]="isDragging"
          [class.dragged]="popupPosition.x !== 0 || popupPosition.y !== 0"
          [ngStyle]="(popupPosition.x !== 0 || popupPosition.y !== 0) ? {'left': popupPosition.x + 'px', 'top': popupPosition.y + 'px'} : {}"
          (mousemove)="onDrag($event)"
          (mouseup)="stopDrag()"
          (mouseleave)="stopDrag()">
          <div class="popup-header" (mousedown)="startDrag($event)">
            <div class="popup-title">
              <div class="popup-status" [class]="getVehicleStatusClass(selectedVehicle)"></div>
              <span class="popup-name">{{ selectedVehicle.brand }} {{ selectedVehicle.model }}</span>
            </div>
            <div class="popup-actions">
              <button class="popup-action-btn" title="Centrer" (mousedown)="$event.stopPropagation()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/>
                </svg>
              </button>
              <button class="popup-action-btn" (click)="selectedVehicle = null; popupPosition = {x: 0, y: 0}" (mousedown)="$event.stopPropagation()" title="Fermer">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
          </div>

          <!-- Tabs -->
          <div class="popup-tabs">
            <button class="popup-tab" [class.active]="activeTab === 'details'" (click)="activeTab = 'details'">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/>
              </svg>
              Détails
            </button>
            <button class="popup-tab" [class.active]="activeTab === 'playback'" (click)="activeTab = 'playback'">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 3 19 12 5 21 5 3"/>
              </svg>
              Playback
            </button>
            <button class="popup-tab" [class.active]="activeTab === 'message'" (click)="activeTab = 'message'">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
              Message
            </button>
          </div>

          <!-- Tab Content -->
          <div class="popup-content">
            <!-- Details Tab -->
            <div class="tab-content" *ngIf="activeTab === 'details'">
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Plaque</span>
                  <span class="info-value plate">{{ selectedVehicle.plate }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Vitesse</span>
                  <span class="info-value">{{ selectedVehicle.currentSpeed || 0 }} km/h</span>
                </div>
                <div class="info-item">
                  <span class="info-label">État</span>
                  <span class="info-value status" [class]="getVehicleStatusClass(selectedVehicle)">
                    {{ getVehicleStatusLabel(selectedVehicle) }}
                  </span>
                </div>
                <div class="info-item">
                  <span class="info-label">Température</span>
                  <span class="info-value">{{ $any(selectedVehicle).temperature || 22 }} °C</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Kilométrage</span>
                  <span class="info-value">{{ selectedVehicle.mileage || 0 }} km</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Carburant</span>
                  <span class="info-value">{{ $any(selectedVehicle).fuelLevel || 75 }} L</span>
                </div>
              </div>
              <div class="driver-section" *ngIf="selectedVehicle.assignedDriverId">
                <span class="section-label">Conducteur</span>
                <div class="driver-info">
                  <div class="driver-avatar">{{ getDriverInitial(selectedVehicle) }}</div>
                  <span class="driver-name">{{ $any(selectedVehicle).driverName || 'Conducteur assigné' }}</span>
                </div>
              </div>
            </div>

            <!-- Playback Tab -->
            <div class="tab-content" *ngIf="activeTab === 'playback'">
              <div class="playback-section">
                <div class="date-range">
                  <div class="date-field">
                    <label>De</label>
                    <input type="datetime-local" [(ngModel)]="playbackFromDate">
                  </div>
                  <div class="date-field">
                    <label>À</label>
                    <input type="datetime-local" [(ngModel)]="playbackToDate">
                  </div>
                </div>
                <button class="load-route-btn" (click)="loadPlaybackRoute()">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                  </svg>
                  Charger le trajet
                </button>
                
                <!-- Road Snapping Toggle -->
                <div class="road-snapping-toggle">
                  <label class="toggle-label">
                    <input type="checkbox" [checked]="useRoadSnapping" (change)="toggleRoadSnapping()">
                    <span class="toggle-slider"></span>
                    <span class="toggle-text">Suivre les routes</span>
                  </label>
                </div>
                <div class="playback-controls" *ngIf="isPlaybackLoaded">
                  <div class="playback-info">
                    <span>Point {{ playbackIndex + 1 }} / {{ playbackPositions.length }}</span>
                    <!-- Bird Flight Filter Badge -->
                    <span class="bird-flight-badge" *ngIf="filteredBirdFlights > 0" (click)="showBirdFlightInfo = !showBirdFlightInfo" title="Points GPS erratiques filtrés">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                      </svg>
                      {{ filteredBirdFlights }} filtrés
                    </span>
                  </div>
                  <!-- Bird Flight Info Popup -->
                  <div class="bird-flight-popup" *ngIf="showBirdFlightInfo && filteredBirdFlights > 0">
                    <div class="popup-header">
                      <strong>Points GPS filtrés</strong>
                      <button class="close-btn" (click)="showBirdFlightInfo = false">×</button>
                    </div>
                    <p>{{ filteredBirdFlights }} point(s) GPS erratique(s) ont été automatiquement filtrés pour améliorer la qualité du tracé.</p>
                    <p class="popup-detail">Ces points présentaient des anomalies telles que:</p>
                    <ul>
                      <li>Vitesse implicite irréaliste (> 200 km/h)</li>
                      <li>Sauts de position impossibles</li>
                      <li>Signal GPS insuffisant</li>
                    </ul>
                  </div>
                  <div class="control-buttons">
                    <button class="control-btn" (click)="resetPlayback()" title="Retour au début">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="19 20 9 12 19 4 19 20"/><line x1="5" y1="19" x2="5" y2="5"/>
                      </svg>
                    </button>
                    <button class="control-btn" (click)="previousPoint()" title="Point précédent">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"/>
                      </svg>
                    </button>
                    <button class="control-btn play" (click)="togglePlayback()" title="{{ isPlaying ? 'Pause' : 'Lecture' }}">
                      <svg *ngIf="!isPlaying" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <polygon points="5 3 19 12 5 21 5 3"/>
                      </svg>
                      <svg *ngIf="isPlaying" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>
                      </svg>
                    </button>
                    <button class="control-btn" (click)="nextPoint()" title="Point suivant">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"/>
                      </svg>
                    </button>
                    <button class="control-btn" (click)="skipToEnd()" title="Aller à la fin">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 4 15 12 5 20 5 4"/><line x1="19" y1="5" x2="19" y2="19"/>
                      </svg>
                    </button>
                  </div>
                  <input type="range" class="progress-slider" [min]="0" [max]="100" [ngModel]="playbackProgress" (ngModelChange)="onPlaybackProgressChange($event)">
                  <div class="speed-selector">
                    <span>Vitesse:</span>
                    <button *ngFor="let s of playbackSpeeds" [class.active]="playbackSpeed === s" (click)="onPlaybackSpeedChange(s)">{{ s }}x</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Message Tab -->
            <div class="tab-content" *ngIf="activeTab === 'message'">
              <div class="message-section">
                <textarea 
                  class="message-input" 
                  placeholder="Écrire un message au conducteur..."
                  [(ngModel)]="driverMessage"
                  rows="4"
                ></textarea>
                <button class="send-message-btn" (click)="sendMessageToDriver()">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
                  </svg>
                  Envoyer
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</app-layout>
