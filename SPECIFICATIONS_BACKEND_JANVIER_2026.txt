================================================================================
                 SP√âCIFICATIONS BACKEND - GIS V2
                 Document technique pour d√©veloppement
                 Date: 23 Janvier 2026
================================================================================

TABLE DES MATI√àRES
==================
1. VUE D'ENSEMBLE DU SYST√àME
2. √âTAT ACTUEL DE LA BASE DE DONN√âES
3. NOUVELLES TABLES √Ä CR√âER
4. MODIFICATIONS DES TABLES EXISTANTES
5. ENDPOINTS API √Ä D√âVELOPPER
6. DTOs ET MOD√àLES
7. R√àGLES DE VALIDATION
8. LOGIQUE M√âTIER
9. S√âCURIT√â ET AUTORISATIONS
10. MIGRATIONS SQL

================================================================================
                    1. VUE D'ENSEMBLE DU SYST√àME
================================================================================

Le syst√®me GIS V2 est une plateforme de gestion de flotte GPS comprenant :
- Frontend Angular (gis-frontend)
- Backend .NET Core (GisAPI)
- Service d'ingestion GPS Rust (gps-ingest-rust)
- Base de donn√©es PostgreSQL
- Message broker RabbitMQ

FONCTIONNALIT√âS IMPL√âMENT√âES (Frontend) N√âCESSITANT BACKEND:
-------------------------------------------------------------
1. Module Fournisseurs/Garages (NOUVEAU)
2. Rapports Infractions Vitesse (OPTIMISATION)
3. Rapports Comportement de Conduite (OPTIMISATION)
4. Interface V√©hicules am√©lior√©e (panneau slide-in)
5. Module √âch√©ances & Documents (NOUVEAU) - Assurance/Taxe/Visite technique
6. Module Sinistres & Accidents (NOUVEAU) - D√©clarations d'accidents v√©hicules

FONCTIONNALIT√âS D√âJ√Ä OP√âRATIONNELLES:
--------------------------------------
- Rapports journaliers (ReportsController)
- Rapports kilom√©triques (ReportsController)
- Rapports mensuels flotte (ReportsController)
- Rapports kilom√©trage par p√©riode (ReportsController)
- D√©tection trajets temps r√©el (Rust TripDetector)
- D√©tection √©v√©nements conduite temps r√©el (Rust DrivingEventsDetector)
- Statistiques quotidiennes (Rust DailyStatisticsCalculator)
- D√©tection arr√™ts (Rust StopDetector)
- Suivi carburant (Rust FuelTracker)
- √âv√©nements geofences (Rust GeofenceDetector)

================================================================================
                    2. √âTAT ACTUEL DE LA BASE DE DONN√âES
================================================================================

TABLES EXISTANTES (Rust - snake_case):
--------------------------------------
| Table             | Description                          | Statut    |
|-------------------|--------------------------------------|-----------|
| gps_positions     | Positions GPS brutes                 | ‚úÖ OK     |
| vehicle_stops     | Arr√™ts d√©tect√©s                      | ‚úÖ OK     |
| fuel_records      | Historique carburant                 | ‚úÖ OK     |
| trips             | Trajets d√©tect√©s                     | ‚úÖ OK     |
| driving_events    | √âv√©nements de conduite               | ‚úÖ OK     |
| daily_statistics  | Statistiques quotidiennes            | ‚úÖ OK     |
| geofence_events   | Entr√©es/sorties geofences            | ‚úÖ OK     |

TABLES EXISTANTES (EF Core - PascalCase):
-----------------------------------------
| Table               | Description                        | Statut    |
|---------------------|---------------------------------------|-----------|
| Companies           | Entreprises clientes                  | ‚úÖ OK     |
| Users               | Utilisateurs                          | ‚úÖ OK     |
| Vehicles            | V√©hicules                             | ‚úÖ OK     |
| GpsDevices          | Appareils GPS                         | ‚úÖ OK     |
| Employees           | Employ√©s/Conducteurs                  | ‚úÖ OK     |
| Geofences           | Zones g√©ographiques                   | ‚úÖ OK     |
| MaintenanceRecords  | Historique maintenance                | ‚úÖ OK     |
| VehicleCosts        | Co√ªts v√©hicules                       | ‚úÖ OK     |
| Reports             | Rapports g√©n√©r√©s                      | ‚úÖ OK     |
| ReportSchedules     | Planification rapports                | ‚úÖ OK     |
| Suppliers           | Fournisseurs (pi√®ces)                 | üü° MODIFIER |
| PartInventory       | Inventaire pi√®ces                     | ‚úÖ OK     |
| Notifications       | Notifications                         | ‚úÖ OK     |
| Subscriptions       | Abonnements                           | ‚úÖ OK     |

================================================================================
                    3. NOUVELLES TABLES √Ä CR√âER
================================================================================

3.1 TABLE: SupplierServices
---------------------------
Description: Table de liaison N:N entre Suppliers et les services propos√©s

| Colonne      | Type                  | Contraintes                    |
|--------------|-----------------------|--------------------------------|
| Id           | SERIAL                | PRIMARY KEY                    |
| SupplierId   | INT                   | NOT NULL, FK ‚Üí Suppliers(Id)   |
| ServiceCode  | VARCHAR(50)           | NOT NULL                       |
| CreatedAt    | TIMESTAMP WITH TZ     | DEFAULT NOW()                  |

Contraintes:
- UNIQUE (SupplierId, ServiceCode)
- ON DELETE CASCADE sur SupplierId

Index:
- IX_SupplierServices_SupplierId (SupplierId)

Codes de services valides:
| Code          | Label fran√ßais            |
|---------------|---------------------------|
| mecanique     | M√©canique g√©n√©rale        |
| carrosserie   | Carrosserie               |
| electricite   | √âlectricit√© auto          |
| pneumatique   | Pneumatiques              |
| vidange       | Vidange & Entretien       |
| climatisation | Climatisation             |
| diagnostic    | Diagnostic √©lectronique   |

================================================================================
                    4. MODIFICATIONS DES TABLES EXISTANTES
================================================================================

4.1 TABLE: Suppliers
--------------------
Ajout de colonnes pour support des garages:

| Colonne      | Type           | Action   | Description              |
|--------------|----------------|----------|--------------------------|
| PostalCode   | VARCHAR(20)    | AJOUTER  | Code postal              |
| Rating       | DECIMAL(3,1)   | MODIFIER | Note 0.0-5.0 (√©tait INT) |

Modification du champ Type - valeurs accept√©es:
- general (existant)
- parts (existant)
- fuel (existant)
- tires (existant)
- service (existant)
- garage (NOUVEAU)

4.2 TABLE: MaintenanceRecords (optionnel)
-----------------------------------------
Liaison optionnelle vers le garage qui a effectu√© l'intervention:

| Colonne    | Type | Action  | Description              |
|------------|------|---------|--------------------------|
| SupplierId | INT  | AJOUTER | FK ‚Üí Suppliers(Id), NULL |

Index:
- IX_MaintenanceRecords_SupplierId (SupplierId)

================================================================================
                    5. ENDPOINTS API √Ä D√âVELOPPER
================================================================================

5.1 MODULE FOURNISSEURS/GARAGES
-------------------------------
Controller: SuppliersController.cs
Route de base: /api/suppliers

| M√©thode | Endpoint              | Description                    | Auth    |
|---------|-----------------------|--------------------------------|---------|
| GET     | /                     | Liste des fournisseurs         | Company |
| GET     | /{id}                 | D√©tail d'un fournisseur        | Company |
| GET     | /stats                | Statistiques (total, actifs)   | Company |
| GET     | /garages              | Liste des garages uniquement   | Company |
| POST    | /                     | Cr√©er un fournisseur           | Company |
| PUT     | /{id}                 | Modifier un fournisseur        | Company |
| DELETE  | /{id}                 | Supprimer un fournisseur       | Company |
| GET     | /{id}/services        | Services d'un fournisseur      | Company |
| PUT     | /{id}/services        | Mettre √† jour les services     | Company |

5.2 RAPPORT INFRACTIONS VITESSE (OPTIMISATION)
----------------------------------------------
Controller: ReportsController.cs
Route: /api/reports/speed-infractions

| M√©thode | Endpoint          | Description                         | Auth    |
|---------|-------------------|-------------------------------------|---------|
| GET     | /speed-infractions| Infractions vitesse consolid√©es     | Company |

Param√®tres de requ√™te:
- startDate (DateTime, requis)
- endDate (DateTime, requis)
- speedLimit (int, d√©faut: 90)
- vehicleId (int?, optionnel - tous si null)
- periodType (string: 'hour'|'day'|'month', d√©faut: 'day')
- page (int, d√©faut: 1)
- pageSize (int, d√©faut: 100)

5.3 RAPPORT COMPORTEMENT CONDUITE (OPTIMISATION)
-------------------------------------------------
Controller: ReportsController.cs
Route: /api/reports/driving-behavior

| M√©thode | Endpoint          | Description                         | Auth    |
|---------|-------------------|-------------------------------------|---------|
| GET     | /driving-behavior | Rapport comportement consolid√©      | Company |

Param√®tres de requ√™te:
- startDate (DateTime, requis)
- endDate (DateTime, requis)
- vehicleId (int?, optionnel - tous si null)
- periodType (string: 'hour'|'day'|'month', d√©faut: 'day')
- includeHarshAcceleration (bool, d√©faut: true)
- includeHarshBraking (bool, d√©faut: true)
- includeSharpSteering (bool, d√©faut: true)
- includeOverspeed (bool, d√©faut: true)
- includeHighRpm (bool, d√©faut: true)
- page (int, d√©faut: 1)
- pageSize (int, d√©faut: 100)

================================================================================
                    6. DTOs ET MOD√àLES
================================================================================

6.1 SupplierDto (R√©ponse API)
-----------------------------
namespace GisAPI.DTOs;

public class SupplierDto
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
    public string Type { get; set; } = "general";
    public string? Address { get; set; }
    public string? City { get; set; }
    public string? PostalCode { get; set; }
    public string? ContactName { get; set; }
    public string? Phone { get; set; }
    public string? Email { get; set; }
    public string? Website { get; set; }
    public decimal Rating { get; set; }
    public string? Notes { get; set; }
    public bool IsActive { get; set; }
    public List<string> Services { get; set; } = new();
    public DateTime CreatedAt { get; set; }
    public DateTime? UpdatedAt { get; set; }
}

6.2 CreateSupplierRequest
-------------------------
public record CreateSupplierRequest(
    string Name,
    string Type,
    string? Address,
    string? City,
    string? PostalCode,
    string? ContactName,
    string? Phone,
    string? Email,
    string? Website,
    decimal? Rating,
    string? Notes,
    bool IsActive,
    List<string>? Services
);

6.3 UpdateSupplierRequest
-------------------------
public record UpdateSupplierRequest(
    string? Name,
    string? Type,
    string? Address,
    string? City,
    string? PostalCode,
    string? ContactName,
    string? Phone,
    string? Email,
    string? Website,
    decimal? Rating,
    string? Notes,
    bool? IsActive,
    List<string>? Services
);

6.4 SupplierStatsDto
--------------------
public class SupplierStatsDto
{
    public int Total { get; set; }
    public int Active { get; set; }
    public int Inactive { get; set; }
    public decimal AverageRating { get; set; }
    public Dictionary<string, int> ByType { get; set; } = new();
}

6.5 SpeedInfractionDto
----------------------
public class SpeedInfractionDto
{
    public int VehicleId { get; set; }
    public string VehicleName { get; set; } = string.Empty;
    public string? VehiclePlate { get; set; }
    public DateTime Timestamp { get; set; }
    public double Latitude { get; set; }
    public double Longitude { get; set; }
    public string? Address { get; set; }
    public double Speed { get; set; }
    public double SpeedLimit { get; set; }
    public double Excess { get; set; }
}

6.6 SpeedInfractionReportDto
----------------------------
public class SpeedInfractionReportDto
{
    public DateTime StartDate { get; set; }
    public DateTime EndDate { get; set; }
    public double SpeedLimit { get; set; }
    public int TotalInfractions { get; set; }
    public int VehiclesWithInfractions { get; set; }
    public double MaxSpeedRecorded { get; set; }
    public double AverageExcess { get; set; }
    public List<SpeedInfractionDto> Infractions { get; set; } = new();
    public Dictionary<string, int> InfractionsByVehicle { get; set; } = new();
    public Dictionary<int, int> InfractionsByHour { get; set; } = new();
}

6.7 DrivingBehaviorIncidentDto
------------------------------
public class DrivingBehaviorIncidentDto
{
    public int VehicleId { get; set; }
    public string VehicleName { get; set; } = string.Empty;
    public string? VehiclePlate { get; set; }
    public DateTime Timestamp { get; set; }
    public string IncidentType { get; set; } = string.Empty;
    public string IncidentLabel { get; set; } = string.Empty;
    public double Latitude { get; set; }
    public double Longitude { get; set; }
    public string? Address { get; set; }
    public double Value { get; set; }
    public string Severity { get; set; } = "low";
}

6.8 DrivingBehaviorReportDto
----------------------------
public class DrivingBehaviorReportDto
{
    public DateTime StartDate { get; set; }
    public DateTime EndDate { get; set; }
    public int TotalIncidents { get; set; }
    public int VehiclesWithIncidents { get; set; }
    public Dictionary<string, int> IncidentsByType { get; set; } = new();
    public Dictionary<string, int> IncidentsBySeverity { get; set; } = new();
    public Dictionary<string, int> IncidentsByVehicle { get; set; } = new();
    public List<DrivingBehaviorIncidentDto> Incidents { get; set; } = new();
}

================================================================================
                    7. R√àGLES DE VALIDATION
================================================================================

7.1 Validation Fournisseur/Garage
---------------------------------
| Champ       | R√®gles                                              |
|-------------|-----------------------------------------------------|
| Name        | Requis, 1-200 caract√®res                            |
| Type        | Enum: general, parts, fuel, tires, service, garage  |
| Address     | Optionnel, max 500 caract√®res                       |
| City        | Optionnel, max 100 caract√®res                       |
| PostalCode  | Optionnel, max 20 caract√®res                        |
| Phone       | Optionnel, format t√©l√©phone valide                  |
| Email       | Optionnel, format email valide                      |
| Rating      | 0.0 - 5.0, incr√©ments de 0.5                        |
| Services    | Tableau de codes valides uniquement                 |
| IsActive    | Boolean                                             |

7.2 Validation Rapport Infractions
----------------------------------
| Champ       | R√®gles                                              |
|-------------|-----------------------------------------------------|
| startDate   | Requis, <= endDate                                  |
| endDate     | Requis, >= startDate, <= maintenant                 |
| speedLimit  | 1 - 300 km/h                                        |
| periodType  | Enum: hour, day, month                              |
| pageSize    | 1 - 1000                                            |

================================================================================
                    8. LOGIQUE M√âTIER
================================================================================

8.1 Calcul Statistiques Fournisseurs
------------------------------------
GetSupplierStats():
  - Total = COUNT(*) WHERE CompanyId = currentCompanyId
  - Active = COUNT(*) WHERE IsActive = true
  - Inactive = Total - Active
  - AverageRating = AVG(Rating) WHERE Rating > 0
  - ByType = GROUP BY Type, COUNT(*)

8.2 Agr√©gation Infractions Vitesse
----------------------------------
GetSpeedInfractions(startDate, endDate, speedLimit, vehicleId?):
  1. R√©cup√©rer positions GPS dans la plage de dates
  2. Filtrer: speedKph > speedLimit
  3. Si vehicleId sp√©cifi√©, filtrer par v√©hicule
  4. Grouper par v√©hicule pour statistiques
  5. Calculer: maxSpeed, avgExcess, countByHour
  6. Paginer r√©sultats
  7. Retourner avec m√©tadonn√©es

8.3 Agr√©gation Comportement Conduite
------------------------------------
GetDrivingBehaviorReport(startDate, endDate, filters, vehicleId?):
  1. Requ√™ter table driving_events
  2. Filtrer par types d'incidents selon filtres
  3. Si vehicleId sp√©cifi√©, filtrer par v√©hicule
  4. Enrichir avec informations v√©hicule
  5. Grouper pour statistiques (byType, bySeverity, byVehicle)
  6. Paginer r√©sultats
  7. Retourner avec m√©tadonn√©es

8.4 Gestion Services Fournisseur
--------------------------------
UpdateSupplierServices(supplierId, services[]):
  1. Valider codes services (liste blanche)
  2. Supprimer anciens services du fournisseur
  3. Ins√©rer nouveaux services
  4. Transaction atomique

================================================================================
                    9. S√âCURIT√â ET AUTORISATIONS
================================================================================

9.1 Authentification
--------------------
- JWT Bearer Token requis pour tous les endpoints
- Token contient: userId, companyId, roles[], permissions[]

9.2 Isolation des donn√©es
-------------------------
- Tous les endpoints filtrent par companyId du token
- Un utilisateur ne peut voir que les donn√©es de sa soci√©t√©
- Exception: r√¥le "admin" peut voir toutes les donn√©es

9.3 Autorisations par endpoint
------------------------------
| Endpoint                     | R√¥le minimum      |
|------------------------------|-------------------|
| GET /api/suppliers           | user              |
| GET /api/suppliers/{id}      | user              |
| GET /api/suppliers/stats     | user              |
| POST /api/suppliers          | manager           |
| PUT /api/suppliers/{id}      | manager           |
| DELETE /api/suppliers/{id}   | admin             |
| GET /api/reports/*           | user              |

================================================================================
                    10. MIGRATIONS SQL
================================================================================

10.1 Migration: AddGarageSupport
--------------------------------
-- Up
ALTER TABLE "Suppliers" ADD COLUMN "PostalCode" VARCHAR(20);

-- Modifier le type de Rating (INT -> DECIMAL)
ALTER TABLE "Suppliers" ALTER COLUMN "Rating" TYPE DECIMAL(3,1) 
  USING COALESCE("Rating", 0)::DECIMAL(3,1);

-- Cr√©er table des services
CREATE TABLE "SupplierServices" (
    "Id" SERIAL PRIMARY KEY,
    "SupplierId" INT NOT NULL,
    "ServiceCode" VARCHAR(50) NOT NULL,
    "CreatedAt" TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    CONSTRAINT "FK_SupplierServices_Suppliers" 
        FOREIGN KEY ("SupplierId") REFERENCES "Suppliers"("Id") ON DELETE CASCADE,
    CONSTRAINT "UQ_SupplierServices_Supplier_Service" 
        UNIQUE ("SupplierId", "ServiceCode")
);

CREATE INDEX "IX_SupplierServices_SupplierId" ON "SupplierServices"("SupplierId");

-- Down
DROP TABLE IF EXISTS "SupplierServices";
ALTER TABLE "Suppliers" DROP COLUMN IF EXISTS "PostalCode";
ALTER TABLE "Suppliers" ALTER COLUMN "Rating" TYPE INT 
  USING ROUND("Rating")::INT;


10.2 Migration: AddGarageToMaintenance (optionnel)
--------------------------------------------------
-- Up
ALTER TABLE "MaintenanceRecords" ADD COLUMN "SupplierId" INT;

ALTER TABLE "MaintenanceRecords" 
    ADD CONSTRAINT "FK_MaintenanceRecords_Suppliers" 
    FOREIGN KEY ("SupplierId") REFERENCES "Suppliers"("Id") ON DELETE SET NULL;

CREATE INDEX "IX_MaintenanceRecords_SupplierId" ON "MaintenanceRecords"("SupplierId");

-- Down
ALTER TABLE "MaintenanceRecords" DROP CONSTRAINT IF EXISTS "FK_MaintenanceRecords_Suppliers";
DROP INDEX IF EXISTS "IX_MaintenanceRecords_SupplierId";
ALTER TABLE "MaintenanceRecords" DROP COLUMN IF EXISTS "SupplierId";

================================================================================
                    11. MODULE √âCH√âANCES & DOCUMENTS
================================================================================

11.1 DESCRIPTION FONCTIONNELLE
------------------------------
Page d√©di√©e √† la gestion des √©ch√©ances de documents v√©hicules :
- Assurance (insurance)
- Vignette/Taxe (tax)
- Visite technique (technical_inspection)
- Carte grise (registration)
- Autorisation transport (transport_permit)

Fonctionnalit√©s:
- Vue globale des √©ch√©ances de toute la flotte
- Indicateurs visuels: üî¥ Expir√©, üü° < 30 jours, üü¢ OK
- Renouvellement avec cr√©ation automatique de d√©pense (VehicleCost)
- Historique des renouvellements
- Export Excel

11.2 MODIFICATIONS TABLE Vehicle
---------------------------------
Ajouter les champs manquants pour les nouvelles √©ch√©ances:

| Colonne             | Type          | Action   | Description           |
|---------------------|---------------|----------|-----------------------|
| TaxExpiry           | DATETIME      | AJOUTER  | Expiration vignette   |
| RegistrationExpiry  | DATETIME      | AJOUTER  | Expiration carte grise|
| TransportPermitExpiry| DATETIME     | AJOUTER  | Expiration autorisation|

Champs existants:
- InsuranceExpiry ‚úÖ
- TechnicalInspectionExpiry ‚úÖ

11.3 MODIFICATIONS TABLE VehicleCost
------------------------------------
Ajouter champs pour lien avec documents:

| Colonne        | Type         | Action   | Description                |
|----------------|--------------|----------|----------------------------|
| ExpiryDate     | DATETIME     | AJOUTER  | Date expiration du document|
| DocumentNumber | VARCHAR(100) | AJOUTER  | N¬∞ police/vignette/PV      |
| DocumentUrl    | VARCHAR(500) | AJOUTER  | URL scan du document       |

11.4 ENDPOINTS API - DocumentsController
----------------------------------------
Route de base: /api/documents

| M√©thode | Endpoint                | Description                    |
|---------|-------------------------|--------------------------------|
| GET     | /expiries               | Liste √©ch√©ances avec statuts   |
| GET     | /expiries/stats         | Compteurs par statut           |
| GET     | /vehicle/{id}/expiries  | √âch√©ances d'un v√©hicule        |
| POST    | /vehicle/{id}/renew     | Renouveler un document         |
| GET     | /vehicle/{id}/history   | Historique renouvellements     |
| GET     | /alerts                 | √âch√©ances √† alerter            |

11.5 DTOs DOCUMENTS
-------------------

VehicleExpiryDto:
  - VehicleId: int
  - VehicleName: string
  - VehiclePlate: string
  - Type: string (insurance, tax, technical_inspection, etc.)
  - ExpiryDate: DateTime?
  - Status: string (expired, expiring_soon, ok)
  - DaysUntilExpiry: int
  - LastRenewalDate: DateTime?
  - LastRenewalCost: decimal?
  - DocumentNumber: string?

ExpiryStatsDto:
  - ExpiredCount: int
  - ExpiringSoonCount: int
  - OkCount: int
  - TotalCount: int

RenewDocumentRequest:
  - VehicleId: int
  - DocumentType: string
  - Amount: decimal
  - PaymentDate: DateTime
  - NewExpiryDate: DateTime
  - DocumentNumber: string?
  - Provider: string?
  - Notes: string?

11.6 LOGIQUE M√âTIER RENOUVELLEMENT
----------------------------------
POST /api/documents/vehicle/{id}/renew:

1. Valider les donn√©es d'entr√©e
2. Cr√©er une entr√©e VehicleCost avec:
   - Type = document type mapp√© (insurance ‚Üí insurance, tax ‚Üí tax, etc.)
   - Description = "Renouvellement {Type} - {Provider}"
   - Amount = montant pay√©
   - Date = date de paiement
   - ExpiryDate = nouvelle date expiration
   - DocumentNumber = num√©ro du document
3. Mettre √† jour le champ Vehicle correspondant:
   - insurance ‚Üí Vehicle.InsuranceExpiry
   - tax ‚Üí Vehicle.TaxExpiry
   - technical_inspection ‚Üí Vehicle.TechnicalInspectionExpiry
   - registration ‚Üí Vehicle.RegistrationExpiry
   - transport_permit ‚Üí Vehicle.TransportPermitExpiry
4. Retourner confirmation avec nouvelles donn√©es

11.7 MIGRATION SQL - AddDocumentExpiries
----------------------------------------
-- Up
ALTER TABLE "Vehicles" ADD COLUMN "TaxExpiry" TIMESTAMP WITH TIME ZONE;
ALTER TABLE "Vehicles" ADD COLUMN "RegistrationExpiry" TIMESTAMP WITH TIME ZONE;
ALTER TABLE "Vehicles" ADD COLUMN "TransportPermitExpiry" TIMESTAMP WITH TIME ZONE;

ALTER TABLE "VehicleCosts" ADD COLUMN "ExpiryDate" TIMESTAMP WITH TIME ZONE;
ALTER TABLE "VehicleCosts" ADD COLUMN "DocumentNumber" VARCHAR(100);
ALTER TABLE "VehicleCosts" ADD COLUMN "DocumentUrl" VARCHAR(500);

-- Down
ALTER TABLE "Vehicles" DROP COLUMN IF EXISTS "TaxExpiry";
ALTER TABLE "Vehicles" DROP COLUMN IF EXISTS "RegistrationExpiry";
ALTER TABLE "Vehicles" DROP COLUMN IF EXISTS "TransportPermitExpiry";

ALTER TABLE "VehicleCosts" DROP COLUMN IF EXISTS "ExpiryDate";
ALTER TABLE "VehicleCosts" DROP COLUMN IF EXISTS "DocumentNumber";
ALTER TABLE "VehicleCosts" DROP COLUMN IF EXISTS "DocumentUrl";

================================================================================
                    12. MODULE SINISTRES & ACCIDENTS
================================================================================

12.1 DESCRIPTION FONCTIONNELLE
------------------------------
Interface compl√®te de gestion des d√©clarations de sinistres v√©hicules :
- Liste des sinistres avec filtres (statut, gravit√©, recherche)
- Panneau slide-in d√©tail (depuis la droite, style coh√©rent avec V√©hicules)
- Formulaire slide-in de cr√©ation/modification
- Barre de statistiques (total, en cours, approuv√©s, montant dommages)
- Gestion des tiers impliqu√©s

Fonctionnalit√©s Frontend:
- Table avec colonnes: N¬∞ Sinistre, V√©hicule, Conducteur, Date, Gravit√©, Montant, Statut
- Filtres: recherche texte, statut, gravit√©
- Panneau d√©tail: infos accident, v√©hicule/conducteur, tiers, dommages, timeline
- Formulaire cr√©ation: 5 sections (V√©hicule, Date/Lieu, Gravit√©/Dommages, Tiers, Description)
- S√©lection multiple des zones endommag√©es
- Toggle tiers impliqu√© avec champs conditionnels

Statuts: draft, submitted, under_review, approved, rejected, closed
Gravit√©s: minor, moderate, major, total_loss

12.2 NOUVELLE TABLE: AccidentClaims
-----------------------------------
| Colonne              | Type              | Contraintes                     |
|----------------------|-------------------|----------------------------------|
| Id                   | SERIAL            | PRIMARY KEY                      |
| ClaimNumber          | VARCHAR(50)       | NOT NULL, UNIQUE                 |
| CompanyId            | INT               | NOT NULL, FK ‚Üí Companies(Id)     |
| VehicleId            | INT               | NOT NULL, FK ‚Üí Vehicles(Id)      |
| DriverId             | INT               | FK ‚Üí Employees(Id)               |
| AccidentDate         | DATE              | NOT NULL                         |
| AccidentTime         | TIME              | NOT NULL                         |
| Location             | VARCHAR(500)      | NOT NULL                         |
| Latitude             | DECIMAL(10,7)     |                                  |
| Longitude            | DECIMAL(10,7)     |                                  |
| WeatherConditions    | VARCHAR(50)       |                                  |
| RoadConditions       | VARCHAR(50)       |                                  |
| Description          | TEXT              | NOT NULL                         |
| Severity             | VARCHAR(20)       | NOT NULL                         |
| EstimatedDamage      | DECIMAL(10,2)     | NOT NULL                         |
| ApprovedAmount       | DECIMAL(10,2)     |                                  |
| Status               | VARCHAR(20)       | NOT NULL DEFAULT 'draft'         |
| ThirdPartyInvolved   | BOOLEAN           | DEFAULT FALSE                    |
| PoliceReportNumber   | VARCHAR(100)      |                                  |
| MileageAtAccident    | INT               |                                  |
| DamagedZones         | VARCHAR(500)      | JSON array                       |
| Witnesses            | TEXT              |                                  |
| AdditionalNotes      | TEXT              |                                  |
| CreatedAt            | TIMESTAMP WITH TZ | DEFAULT NOW()                    |
| UpdatedAt            | TIMESTAMP WITH TZ | DEFAULT NOW()                    |
| CreatedBy            | INT               | FK ‚Üí Users(Id)                   |

12.3 NOUVELLE TABLE: AccidentClaimThirdParties
----------------------------------------------
| Colonne              | Type              | Contraintes                     |
|----------------------|-------------------|----------------------------------|
| Id                   | SERIAL            | PRIMARY KEY                      |
| ClaimId              | INT               | NOT NULL, FK ‚Üí AccidentClaims(Id)|
| Name                 | VARCHAR(200)      |                                  |
| Phone                | VARCHAR(50)       |                                  |
| VehiclePlate         | VARCHAR(50)       |                                  |
| VehicleModel         | VARCHAR(100)      |                                  |
| InsuranceCompany     | VARCHAR(200)      |                                  |
| InsuranceNumber      | VARCHAR(100)      |                                  |
| CreatedAt            | TIMESTAMP WITH TZ | DEFAULT NOW()                    |

12.4 NOUVELLE TABLE: AccidentClaimDocuments
-------------------------------------------
| Colonne              | Type              | Contraintes                     |
|----------------------|-------------------|----------------------------------|
| Id                   | SERIAL            | PRIMARY KEY                      |
| ClaimId              | INT               | NOT NULL, FK ‚Üí AccidentClaims(Id)|
| DocumentType         | VARCHAR(50)       | NOT NULL (photo, police_report, etc)|
| FileName             | VARCHAR(255)      | NOT NULL                         |
| FileUrl              | VARCHAR(500)      | NOT NULL                         |
| FileSize             | INT               |                                  |
| MimeType             | VARCHAR(100)      |                                  |
| UploadedAt           | TIMESTAMP WITH TZ | DEFAULT NOW()                    |

12.5 ENDPOINTS API - AccidentClaimsController
---------------------------------------------
Route de base: /api/accident-claims

| M√©thode | Endpoint                  | Description                      |
|---------|---------------------------|----------------------------------|
| GET     | /                         | Liste toutes les d√©clarations    |
| GET     | /{id}                     | D√©tail d'une d√©claration         |
| POST    | /                         | Cr√©er nouvelle d√©claration       |
| PUT     | /{id}                     | Modifier une d√©claration         |
| DELETE  | /{id}                     | Supprimer (brouillon uniquement) |
| POST    | /{id}/submit              | Soumettre pour r√©vision          |
| POST    | /{id}/approve             | Approuver (admin)                |
| POST    | /{id}/reject              | Rejeter (admin)                  |
| POST    | /{id}/close               | Cl√¥turer                         |
| GET     | /stats                    | Statistiques globales            |
| GET     | /vehicle/{vehicleId}      | Sinistres d'un v√©hicule          |
| POST    | /{id}/documents           | Upload document/photo            |
| DELETE  | /{id}/documents/{docId}   | Supprimer document               |

12.6 DTOs SINISTRES
-------------------

AccidentClaimDto:
  - Id: int
  - ClaimNumber: string
  - VehicleId: int
  - VehicleName: string
  - VehiclePlate: string
  - DriverId: int?
  - DriverName: string?
  - AccidentDate: DateTime
  - AccidentTime: string
  - Location: string
  - Description: string
  - Severity: string
  - EstimatedDamage: decimal
  - ApprovedAmount: decimal?
  - Status: string
  - ThirdPartyInvolved: bool
  - PoliceReportNumber: string?
  - CreatedAt: DateTime
  - UpdatedAt: DateTime
  - Documents: AccidentClaimDocumentDto[]
  - ThirdParties: AccidentClaimThirdPartyDto[]

CreateAccidentClaimRequest:
  - VehicleId: int (required)
  - DriverId: int (required)
  - AccidentDate: DateTime (required)
  - AccidentTime: string (required)
  - Location: string (required)
  - Description: string (required)
  - Severity: string (required, enum: minor|moderate|major|total_loss)
  - EstimatedDamage: decimal (required)
  - DamagedZones: string[] (optional, ex: ["Avant", "Arri√®re", "C√¥t√© gauche"])
  - ThirdPartyInvolved: bool (default: false)
  - ThirdPartyName: string?
  - ThirdPartyPhone: string?
  - ThirdPartyVehicle: string?
  - ThirdPartyInsurance: string?

Note: Les champs WeatherConditions, RoadConditions, PoliceReportNumber sont 
conserv√©s en DB mais non utilis√©s dans le formulaire frontend actuel.

AccidentClaimStatsDto:
  - TotalClaims: int
  - DraftCount: int
  - SubmittedCount: int
  - UnderReviewCount: int
  - ApprovedCount: int
  - RejectedCount: int
  - ClosedCount: int
  - TotalEstimatedDamage: decimal
  - TotalApprovedAmount: decimal

12.7 R√àGLES M√âTIER
------------------
1. Seuls les brouillons peuvent √™tre modifi√©s/supprim√©s
2. ClaimNumber auto-g√©n√©r√©: SIN-{ANN√âE}-{SEQUENCE}
3. Notification envoy√©e √† l'admin lors de la soumission
4. Historique des changements de statut enregistr√©
5. Photos limit√©es √† 10 Mo chacune, formats: jpg, png, webp
6. Documents accept√©s: pdf, doc, docx (max 20 Mo)

12.8 MIGRATION SQL - AddAccidentClaims
--------------------------------------
-- Up
CREATE TABLE "AccidentClaims" (
    "Id" SERIAL PRIMARY KEY,
    "ClaimNumber" VARCHAR(50) NOT NULL UNIQUE,
    "CompanyId" INT NOT NULL REFERENCES "Companies"("Id"),
    "VehicleId" INT NOT NULL REFERENCES "Vehicles"("Id"),
    "DriverId" INT REFERENCES "Employees"("Id"),
    "AccidentDate" DATE NOT NULL,
    "AccidentTime" TIME NOT NULL,
    "Location" VARCHAR(500) NOT NULL,
    "Latitude" DECIMAL(10,7),
    "Longitude" DECIMAL(10,7),
    "WeatherConditions" VARCHAR(50),
    "RoadConditions" VARCHAR(50),
    "Description" TEXT NOT NULL,
    "Severity" VARCHAR(20) NOT NULL,
    "EstimatedDamage" DECIMAL(10,2) NOT NULL,
    "ApprovedAmount" DECIMAL(10,2),
    "Status" VARCHAR(20) NOT NULL DEFAULT 'draft',
    "ThirdPartyInvolved" BOOLEAN DEFAULT FALSE,
    "PoliceReportNumber" VARCHAR(100),
    "MileageAtAccident" INT,
    "DamagedZones" VARCHAR(500),
    "Witnesses" TEXT,
    "AdditionalNotes" TEXT,
    "CreatedAt" TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    "UpdatedAt" TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    "CreatedBy" INT REFERENCES "Users"("Id")
);

CREATE TABLE "AccidentClaimThirdParties" (
    "Id" SERIAL PRIMARY KEY,
    "ClaimId" INT NOT NULL REFERENCES "AccidentClaims"("Id") ON DELETE CASCADE,
    "Name" VARCHAR(200),
    "Phone" VARCHAR(50),
    "VehiclePlate" VARCHAR(50),
    "VehicleModel" VARCHAR(100),
    "InsuranceCompany" VARCHAR(200),
    "InsuranceNumber" VARCHAR(100),
    "CreatedAt" TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE "AccidentClaimDocuments" (
    "Id" SERIAL PRIMARY KEY,
    "ClaimId" INT NOT NULL REFERENCES "AccidentClaims"("Id") ON DELETE CASCADE,
    "DocumentType" VARCHAR(50) NOT NULL,
    "FileName" VARCHAR(255) NOT NULL,
    "FileUrl" VARCHAR(500) NOT NULL,
    "FileSize" INT,
    "MimeType" VARCHAR(100),
    "UploadedAt" TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX "IX_AccidentClaims_CompanyId" ON "AccidentClaims"("CompanyId");
CREATE INDEX "IX_AccidentClaims_VehicleId" ON "AccidentClaims"("VehicleId");
CREATE INDEX "IX_AccidentClaims_Status" ON "AccidentClaims"("Status");
CREATE INDEX "IX_AccidentClaims_AccidentDate" ON "AccidentClaims"("AccidentDate");

-- Down
DROP TABLE IF EXISTS "AccidentClaimDocuments";
DROP TABLE IF EXISTS "AccidentClaimThirdParties";
DROP TABLE IF EXISTS "AccidentClaims";

================================================================================
                    13. MODULE ENTRETIENS MA√éTRES
================================================================================

13.1 DESCRIPTION FONCTIONNELLE
------------------------------
Gestion des entretiens r√©currents des v√©hicules bas√©s sur le kilom√©trage ou le temps.

Interface Frontend:
- Onglet 1: Mod√®les d'entretien (templates r√©utilisables)
- Onglet 2: Planning v√©hicules (statut par v√©hicule)
- Formulaire cr√©ation/modification de mod√®le
- Formulaire "Marquer comme effectu√©" (cr√©e une d√©pense)
- Alertes visuelles: En retard, √Ä faire, √Ä venir, OK

Fonctionnalit√©s:
- D√©finition de mod√®les avec intervalles km ET/OU mois
- Priorit√©s: low, medium, high, critical
- Cat√©gories: Moteur, Freinage, Transmission, Filtres, √âlectrique, Suspension
- Calcul automatique du prochain entretien
- Liaison avec VehicleCosts lors de l'enregistrement

13.2 NOUVELLE TABLE: MaintenanceTemplates
-----------------------------------------
| Colonne              | Type              | Contraintes                     |
|----------------------|-------------------|----------------------------------|
| Id                   | SERIAL            | PRIMARY KEY                      |
| CompanyId            | INT               | NOT NULL, FK ‚Üí Companies(Id)     |
| Name                 | VARCHAR(100)      | NOT NULL                         |
| Description          | VARCHAR(500)      |                                  |
| Category             | VARCHAR(50)       | NOT NULL                         |
| Priority             | VARCHAR(20)       | NOT NULL DEFAULT 'medium'        |
| IntervalKm           | INT               | Intervalle en kilom√®tres         |
| IntervalMonths       | INT               | Intervalle en mois               |
| EstimatedCost        | DECIMAL(10,2)     | Co√ªt moyen estim√©                |
| IsActive             | BOOLEAN           | DEFAULT TRUE                     |
| CreatedAt            | TIMESTAMP WITH TZ | DEFAULT NOW()                    |
| UpdatedAt            | TIMESTAMP WITH TZ | DEFAULT NOW()                    |

Note: Au moins un intervalle (IntervalKm OU IntervalMonths) doit √™tre d√©fini.

13.3 NOUVELLE TABLE: VehicleMaintenanceSchedule
-----------------------------------------------
| Colonne              | Type              | Contraintes                     |
|----------------------|-------------------|----------------------------------|
| Id                   | SERIAL            | PRIMARY KEY                      |
| VehicleId            | INT               | NOT NULL, FK ‚Üí Vehicles(Id)      |
| TemplateId           | INT               | NOT NULL, FK ‚Üí MaintenanceTemplates(Id)|
| LastDoneDate         | DATE              | Date du dernier entretien        |
| LastDoneKm           | INT               | Kilom√©trage au dernier entretien |
| NextDueDate          | DATE              | Prochaine √©ch√©ance (calcul√©e)    |
| NextDueKm            | INT               | Prochain km (calcul√©)            |
| Status               | VARCHAR(20)       | ok, upcoming, due, overdue       |
| CreatedAt            | TIMESTAMP WITH TZ | DEFAULT NOW()                    |
| UpdatedAt            | TIMESTAMP WITH TZ | DEFAULT NOW()                    |

UNIQUE CONSTRAINT: (VehicleId, TemplateId)

13.4 NOUVELLE TABLE: MaintenanceRecords
---------------------------------------
| Colonne              | Type              | Contraintes                     |
|----------------------|-------------------|----------------------------------|
| Id                   | SERIAL            | PRIMARY KEY                      |
| VehicleId            | INT               | NOT NULL, FK ‚Üí Vehicles(Id)      |
| TemplateId           | INT               | NOT NULL, FK ‚Üí MaintenanceTemplates(Id)|
| ScheduleId           | INT               | FK ‚Üí VehicleMaintenanceSchedule(Id)|
| CostId               | INT               | FK ‚Üí VehicleCosts(Id)            |
| DoneDate             | DATE              | NOT NULL                         |
| DoneKm               | INT               | NOT NULL                         |
| ActualCost           | DECIMAL(10,2)     | NOT NULL                         |
| SupplierId           | INT               | FK ‚Üí Suppliers(Id)               |
| Notes                | TEXT              |                                  |
| CreatedAt            | TIMESTAMP WITH TZ | DEFAULT NOW()                    |

13.5 ENDPOINTS API - MaintenanceTemplatesController
---------------------------------------------------
Route de base: /api/maintenance-templates

| M√©thode | Endpoint                      | Description                         |
|---------|-------------------------------|-------------------------------------|
| GET     | /                             | Liste des mod√®les d'entretien       |
| GET     | /{id}                         | D√©tail d'un mod√®le                  |
| POST    | /                             | Cr√©er un mod√®le                     |
| PUT     | /{id}                         | Modifier un mod√®le                  |
| DELETE  | /{id}                         | Supprimer un mod√®le                 |
| GET     | /categories                   | Liste des cat√©gories disponibles    |

13.6 ENDPOINTS API - VehicleMaintenanceScheduleController
---------------------------------------------------------
Route de base: /api/vehicle-maintenance

| M√©thode | Endpoint                      | Description                         |
|---------|-------------------------------|-------------------------------------|
| GET     | /                             | Planning de tous les v√©hicules      |
| GET     | /vehicle/{vehicleId}          | Planning d'un v√©hicule              |
| GET     | /alerts                       | Entretiens en retard ou √† faire     |
| GET     | /stats                        | Statistiques globales               |
| POST    | /assign                       | Assigner un mod√®le √† un v√©hicule    |
| DELETE  | /{scheduleId}                 | Retirer un entretien du planning    |
| POST    | /mark-done                    | Marquer un entretien comme effectu√© |

13.7 DTOs ENTRETIENS MA√éTRES
----------------------------

MaintenanceTemplateDto:
  - Id: int
  - Name: string
  - Description: string?
  - Category: string
  - Priority: string (low, medium, high, critical)
  - IntervalKm: int?
  - IntervalMonths: int?
  - EstimatedCost: decimal
  - IsActive: bool

CreateMaintenanceTemplateRequest:
  - Name: string (required)
  - Description: string?
  - Category: string (required)
  - Priority: string (default: medium)
  - IntervalKm: int? (au moins un requis)
  - IntervalMonths: int? (au moins un requis)
  - EstimatedCost: decimal?
  - IsActive: bool (default: true)

VehicleMaintenanceStatusDto:
  - VehicleId: int
  - VehicleName: string
  - VehiclePlate: string
  - CurrentMileage: int
  - MaintenanceItems: MaintenanceItemDto[]

MaintenanceItemDto:
  - TemplateId: int
  - TemplateName: string
  - LastDoneDate: DateTime?
  - LastDoneKm: int?
  - NextDueDate: DateTime?
  - NextDueKm: int?
  - Status: string (ok, upcoming, due, overdue)
  - KmUntilDue: int?
  - DaysUntilDue: int?

MarkMaintenanceDoneRequest:
  - VehicleId: int (required)
  - TemplateId: int (required)
  - Date: DateTime (required)
  - Mileage: int (required)
  - Cost: decimal (required)
  - SupplierId: int?
  - Notes: string?

13.8 R√àGLES M√âTIER
------------------
1. Un entretien est "overdue" si: (km actuel - dernier km) > intervalle km OU (date actuelle - derni√®re date) > intervalle mois
2. Un entretien est "due" si: d√©passement imminent (< 1000 km OU < 30 jours)
3. Un entretien est "upcoming" si: proche mais pas urgent (< 5000 km OU < 90 jours)
4. Lors du "mark done":
   - Cr√©er un VehicleCost avec CostType='maintenance'
   - Mettre √† jour VehicleMaintenanceSchedule
   - Cr√©er un MaintenanceRecord
   - Mettre √† jour Vehicle.Mileage si n√©cessaire
5. Les mod√®les peuvent √™tre d√©sactiv√©s sans √™tre supprim√©s

13.9 MIGRATION SQL - AddMaintenanceTemplates
--------------------------------------------
-- Up
CREATE TABLE "MaintenanceTemplates" (
    "Id" SERIAL PRIMARY KEY,
    "CompanyId" INT NOT NULL REFERENCES "Companies"("Id"),
    "Name" VARCHAR(100) NOT NULL,
    "Description" VARCHAR(500),
    "Category" VARCHAR(50) NOT NULL,
    "Priority" VARCHAR(20) NOT NULL DEFAULT 'medium',
    "IntervalKm" INT,
    "IntervalMonths" INT,
    "EstimatedCost" DECIMAL(10,2),
    "IsActive" BOOLEAN DEFAULT TRUE,
    "CreatedAt" TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    "UpdatedAt" TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    CONSTRAINT "CK_MaintenanceTemplates_Interval" CHECK ("IntervalKm" IS NOT NULL OR "IntervalMonths" IS NOT NULL)
);

CREATE TABLE "VehicleMaintenanceSchedule" (
    "Id" SERIAL PRIMARY KEY,
    "VehicleId" INT NOT NULL REFERENCES "Vehicles"("Id") ON DELETE CASCADE,
    "TemplateId" INT NOT NULL REFERENCES "MaintenanceTemplates"("Id") ON DELETE CASCADE,
    "LastDoneDate" DATE,
    "LastDoneKm" INT,
    "NextDueDate" DATE,
    "NextDueKm" INT,
    "Status" VARCHAR(20) DEFAULT 'upcoming',
    "CreatedAt" TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    "UpdatedAt" TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    CONSTRAINT "UQ_VehicleMaintenanceSchedule" UNIQUE ("VehicleId", "TemplateId")
);

CREATE TABLE "MaintenanceRecords" (
    "Id" SERIAL PRIMARY KEY,
    "VehicleId" INT NOT NULL REFERENCES "Vehicles"("Id"),
    "TemplateId" INT NOT NULL REFERENCES "MaintenanceTemplates"("Id"),
    "ScheduleId" INT REFERENCES "VehicleMaintenanceSchedule"("Id"),
    "CostId" INT REFERENCES "VehicleCosts"("Id"),
    "DoneDate" DATE NOT NULL,
    "DoneKm" INT NOT NULL,
    "ActualCost" DECIMAL(10,2) NOT NULL,
    "SupplierId" INT REFERENCES "Suppliers"("Id"),
    "Notes" TEXT,
    "CreatedAt" TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX "IX_MaintenanceTemplates_CompanyId" ON "MaintenanceTemplates"("CompanyId");
CREATE INDEX "IX_VehicleMaintenanceSchedule_VehicleId" ON "VehicleMaintenanceSchedule"("VehicleId");
CREATE INDEX "IX_VehicleMaintenanceSchedule_Status" ON "VehicleMaintenanceSchedule"("Status");
CREATE INDEX "IX_MaintenanceRecords_VehicleId" ON "MaintenanceRecords"("VehicleId");

-- Down
DROP TABLE IF EXISTS "MaintenanceRecords";
DROP TABLE IF EXISTS "VehicleMaintenanceSchedule";
DROP TABLE IF EXISTS "MaintenanceTemplates";

================================================================================
                    FIN DU DOCUMENT
================================================================================

Notes de r√©vision:
- Version 1.0 - 23/01/2026 - Cr√©ation initiale
- Version 1.1 - 23/01/2026 - Ajout module √âch√©ances & Documents
- Version 1.2 - 23/01/2026 - Ajout module Sinistres & Accidents
- Version 1.3 - 23/01/2026 - Mise √† jour Sinistres: UI slide-in, formulaire simplifi√©
- Version 1.4 - 23/01/2026 - Ajout module Entretiens Ma√Ætres
- Auteur: Syst√®me Cascade
- Valid√© par: [√Ä compl√©ter]

================================================================================
